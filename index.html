<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Video Auto-Download</title>
    <script>
        // Function to parse query parameters from the URL
        function getQueryParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Function to start the download
        function startDownload(videoUrl) {
            const link = document.createElement('a');
            link.href = videoUrl;
            link.download = 'youtube.mp4'; // Default file name
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // On document load, process the video ID and trigger the download
        document.addEventListener('DOMContentLoaded', () => {
            const videoId = getQueryParameter('id');
            if (videoId) {
                const ajaxUrl = `http://localhost/?id=${videoId}`; // Update with your backend URL

                fetch(ajaxUrl)
                    .then(response => response.text())
                    .then(data => {
                        const parsedData = parseVideoData(data);
                        const videoData = parsedData.video_info;
                        if (videoData) {
                            const videoArr = videoData["url_encoded_fmt_stream_map"];
                            const videoUrl = videoArr.find(v => v.quality === "hd720")?.url;

                            if (videoUrl) {
                                startDownload(videoUrl);
                            } else {
                                document.body.innerHTML = '<p>No HD720 quality available.</p>';
                            }
                        } else {
                            document.body.innerHTML = '<p>Error retrieving video data.</p>';
                        }
                    })
                    .catch(() => {
                        document.body.innerHTML = '<p>Error connecting to the server.</p>';
                    });
            } else {
                document.body.innerHTML = '<p>No video ID provided.</p>';
            }
        });

        // Function to parse video data from the backend response
        function parseVideoData(data) {
            function qsToJson(qs) {
                const res = {};
                const pars = qs.split('&');
                pars.forEach(par => {
                    const [k, v] = par.split('=');
                    res[k] = decodeURIComponent(v);
                });
                return res;
            }

            const getVideoInfo = qsToJson(data);
            if (getVideoInfo.status === 'fail') {
                return { status: "error", code: "invalid_url", msg: "Check your URL or video ID" };
            } else {
                const videoArr = getVideoInfo["url_encoded_fmt_stream_map"];
                if (videoArr) {
                    getVideoInfo["url_encoded_fmt_stream_map"] = videoArr.split(',').map(qsToJson);
                }
                return { status: 'success', video_info: getVideoInfo };
            }
        }
    </script>
</head>
<body>
    <h1>Processing Your Request...</h1>
    <p>If the download does not start automatically, please check your URL.</p>
</body>
</html>
